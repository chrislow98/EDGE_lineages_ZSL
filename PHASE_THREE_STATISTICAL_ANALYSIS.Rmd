---
title: "PHASE_THREE_STATISTICAL_ANALYSIS"
author: "Chris Low"
date: "01/09/2021"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse) # data wrangling and visualization
library(ggplot2) # data visualization
library(GGally) # visulizing scatterplots
library(performance) # check model outputs
library(lme4) # analysis for logistic regressions and mixed-effects modelling
library(corrplot) # creating a correlation matrix
library(sjPlot) # to visualizing mixed-effects models
library(effects) # to visualizing mixed-effects models
library(report) # mainly for an "report" function
library(emmeans) # post-hoc analysis
library(knitr) # beautifying tables
library(MASS) # building negative binomial GLM's
library(pscl) # zero-inflation regression models
```

## Loading in final dataset in r

```{r load data, echo=TRUE}

# Just save priority EDGE lineage list and PD_mammal_merged list as essential for analysis: mammals_pd_merged, EDGE_priority_lineages, ePD_priority_lineages (final datasets so far!!!)
load("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/EDGE_families_and_scores/EDGE_LINEAGES_FOR_ANALYSIS.RData")

# load dataout datasets with both Upham and Gumbs datasets
load("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Mammal phylogenies/ePD_scores_ALL.RData")

```

## Testing the difference between

You can also embed plots, for example:

```{r testing phylogeny datasets, echo=FALSE}

# Spearmans's rank correaltion between imputted an non-imputed datasets
cor.test(ex_PD_full$Median.exPD, ex_PD_full$Median.ePD.UPHAM, method = "spearman")

# subset and log variables
ePD_spp_rich_df <- mammals_pd_merged[,c(3,14)]


# Spearman's rank correlation between species richness and ePD
cor.test(mammals_pd_merged$richness, mammals_pd_merged$Median.exPD, method = "spearman")

shapiro.test(mammals_pd_merged$richness)
shapiro.test(ePD_response_df$ePD_log)

```
## Question (i) is the response of ePD loss a good predictor of extinction risk?
# Use a poission distribution

Do intrinsic and extrinsic threats predict ePD loss?

```{r ePD loss question, echo=TRUE}

ePD_response_df <- mammals_pd_merged[,c(1:3,9,14,21,23,25,29,31,33,35,37,39,41,43,45,46:48)]

# visulising distributions of data
# distribution of response variable is poission
par(mfrow=c(3:4))
for(i in 3:24) {
    hist(ePD_response_df[,i], main=names(ePD_response_df)[i])
}

# log transforming variables
ePD_response_df$ePD_log <- log(ePD_response_df$Median.exPD)
ePD_response_df$bodysize_log <- log(ePD_response_df$bodysize_mean)
ePD_response_df$gensize_log <- log(ePD_response_df$Gen_length_days)
ePD_response_df$threat_sum <- rowSums(ePD_response_df[,c("prop_1_1", "prop_2_2", "prop_2_3", "prop_5_1", "prop_5_3", "prop_8_1")])

hist(ePD_response_df$ePD_log)

# Change characters to factors
ePD_response_df$Family <- as.factor(ePD_response_df$Family)
ePD_response_df$Order <- as.factor(ePD_response_df$Order)


# check colinearity of data
# creating a correlation matrix
correlations <- cor(ePD_response_df[,3:21])
corrplot(correlations, method="circle")

# fill in all NA's as 0's
ePD_response_df[is.na(ePD_response_df)] <- 0

# run a glm using 
ePD_glm <- glm(ePD_log ~ bodysize_log + gensize_log + prop_1_1 + prop_2_2 + prop_2_3 + prop_5_1 + prop_5_3 + prop_8_1, family = gaussian, data = ePD_response_df) 

summary(ePD_glm)

with(summary(ePD_glm), 1 - deviance/null.deviance)

check_model(ePD_glm)

# run a glm- without individual threats
ePD_glm <- glm(Median.exPD ~ bodysize_mean + Gen_length_days + threat_sum, family = "poisson", data = ePD_response_df) 

# using a zero inflation glm 


summary(ePD_glm)

# find out explanatory power
with(summary(ePD_glm), 1 - deviance/null.deviance)

check_model(ePD_glm)

# now try glmm to see if it can explain any additional variation
# building a mixed-effects linear logistic regression
GLMM_ePD <- glmer(Median.exPD ~ bodysize_mean + Gen_length_days + threat_sum + prop_1_1 + prop_2_2 + prop_2_3 + prop_5_1 + prop_5_3 + prop_8_1 + 
                    (1 | Order), 
                    data = ePD_response_df,
                    family = poisson,
                    control = glmerControl(optimizer = "bobyqa"))

```

## Question (ii) Is the population status of priority lineages in a greater state of decline than non-priority lineages?


```{r explore data, echo=TRUE}

# subset data to only contain population probabilities
priority_lineages_df <- mammals_pd_merged[,c(1,2,3,9,21,23,25,29,31,33, 48:50)]

names(priority_lineages_df)

head(priority_lineages_df)

summary(priority_lineages_df)

# Change order to a factor
priority_lineages_df$Order <- as.factor(priority_lineages_df$Order)
priority_lineages_df$priority_type <- as.factor(priority_lineages_df$priority_type)

# convert prioirty values to 1's and 0's
priority_lineages_df$EDGE_priority[priority_lineages_df$EDGE_priority == "No"] <- 0
priority_lineages_df$EDGE_priority[priority_lineages_df$EDGE_priority == "Yes"] <- 1

# change to binary operator
priority_lineages_df$EDGE_priority <- as.numeric(priority_lineages_df$EDGE_priority)


# visulising distibutions of data
par(mfrow=c(3,4))
for(i in 3:11) {
    hist(priority_lineages_df[,i], main=names(priority_lineages_df)[i])
}

# Viewing the distribution of variables
GGally::ggpairs(priority_lineages_df[, c("assessed_threat_prop", "Prop_dec", "Prop_inc", "Prop_stab")])

# boxplot
boxplot(priority_lineages_df$Prop_dec)

# creating a correlation matrix
correlations <- cor(priority_lineages_df[,3:11])
corrplot(correlations, method="circle")

# Replace all NA values with 0
priority_lineages_df[is.na(priority_lineages_df)] <- 0

# double check strucutre of dataset
str(priority_lineages_df)

# check for generalized inflation factors - look at colinearity  
corvif(EDGE_priority_lineages)

# some of the data follows a bimodal distiribtuion
# perform a glm fit
priority_lineage_glm <- glm(EDGE_priority ~ Prop_dec + Prop_inc + Prop_stab + prop_uplisted + prop_downlisted + prop_stable, weights = wt, family = binomial("logit"), data = priority_lineages_df)

summary(priority_lineage_glm)

priority_lineage_glm <- glm.nb(EDGE_priority ~ Prop_dec + Prop_inc + Prop_stab + prop_uplisted + prop_downlisted + prop_stable, data = priority_lineages_df)

# check for model performance
performance::check_model(priority_lineage_glm)

# Get summary of results
summary(priority_lineage_glm)

# find out explanatory power
with(summary(priority_lineage_glm), 1 - deviance/null.deviance)

# try a zero-inflated binomial regression
m1 <- zeroinfl(EDGE_priority ~ Prop_dec + Prop_inc + Prop_stab + prop_uplisted + prop_downlisted + prop_stable | priority_type,
  data = priority_lineages_df, dist = "poisson")

summary(m1)

m1 <- zeroinfl(EDGE_priority ~ Trend_dec + Trend_inc + Trend_stab + no_stable + no_uplisted + no_downlisted | priority_type,
  data = mammals_pd_merged, dist = "negbin")


# building a mixed-effects linear logistic regression
GLMM_prioirty_lineages <- glmer(EDGE_priority ~ Prop_dec + Prop_inc + Prop_stab + prop_downlisted + prop_uplisted + prop_stable + (1 | Order), 
                                data = priority_lineages_df,
                                family = binomial,
                                control = glmerControl(optimizer = "bobyqa"))

m <- glmer(EDGE_priority ~ Prop_dec + Prop_inc + Prop_stab + prop_downlisted + prop_uplisted + prop_stable + 
           (1 | Order), 
           data = priority_lineages_df, 
           family = binomial, 
           control = glmerControl(optimizer = "bobyqa"),
           nAGQ = 10)

GLMM_priority_lineages <- glmer.nb(EDGE_priority ~ Prop_dec + Prop_inc + Prop_stab + prop_downlisted + prop_uplisted + prop_stable + (1 | Family/Order), data = priority_lineages_df, 
                 control = glmerControl(optimizer = "bobyqa"))

check_model(m_ri)

summary(m_ri)

tab_model(m_ri, show.aic = T)

```

## Question (iii) Is the response of population status/family associated with the concentration of anthropogenic threats for priority lineages

```{r threat analaysis, echo=TRUE}

#subset threat data
threat_analysis_df <- mammals_pd_merged[,c(1:3,9,21,29, 34:45)]

# creating a correlation matrix - no correlations between variables. Can therefore dismiss the assumption of non-independence
correlations <- cor(threat_analysis_df[,3:18])
corrplot(correlations, method="circle")

```
