---
title: "PHASE_TWO_MONITORING_POPULATION_STATUS"
author: "Chris Low"
date: "18/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

# PHASE TWO: MONITORING THE POPULATION STATUS OF EVOLUTIONARY DISTINCT LIENAGES

```{r load packages, echo=FALSE}

library(dplyr) # data manipulation
library(plyr)
library(rredlist) # extract data from IUCN Red List
library(stringr) # dealing with changes to texts and strings
library(tidyverse)
library(remotes) # install github packages
library(devtools) # install github packages
library(traitdataform)
library(traitdata) # get data from PANTHERIA
library(rlpi) # calculate LPI lambdas

```


Load in data to monitor population for Mammal lineages

```{r load data, echo=FALSE}

EDGE_mammals <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/EDGE_families_and_scores/EDGE2_mammals.csv", stringsAsFactors = FALSE)

mammals_old_RLI <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Monitoring_population_trends/Mammal_RLI.csv")

IUCN_pop_trend <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Monitoring_population_trends/pop_trend_IUCN.csv")

```

# Function to calculate the Red List Index (RLI)

```{r Red List function, echo=FALSE}

## RLI script

# Label Red List categories
wtEX<-5
wtPE<-5
wtEW<-5
wtPEW<-5
wtCR<-4
wtEN<-3
wtVU<-2
wtNT<-1
wtLC<-0

# Function to calculate the RLI from a set of species categories

get_rli <- function(species_categories) {
  # Get the number of species in each category, including the old categories
  nEX<-sum(species_categories=="EX" | species_categories=="E", na.rm = T)
  nPE<-sum(species_categories=="PE", na.rm = T)
  nEW<-sum(species_categories=="EW", na.rm = T)
  nPEW<-sum(species_categories=="PEW", na.rm = T)
  nCR<-sum(species_categories=="CR", na.rm = T)
  nEN<-sum(species_categories=="EN", na.rm = T)
  nVU<-sum(species_categories=="VU" | species_categories=="T", na.rm = T)
  nNT<-sum(species_categories=="NT"  | species_categories=="LR/nt", na.rm = T)
  nLC<-sum(species_categories=="LC" | species_categories=="LR/lc" | species_categories=="LR/cd", na.rm = T)
  
  # Multiply these by the respective weights and sum
  Total<-(wtEX*nEX)+(wtPE*nPE)+(wtEW*nEW)+(wtPEW*nPEW)+(wtCR*nCR)+(wtEN*nEN)+(wtVU*nVU)+(wtNT*nNT)+(wtLC*nLC)
  
  # Work out the âworse case scenarioâ
  M<-((nEX+nPE+nEW+nPEW+nCR+nEN+nVU+nNT+nLC)*wtEX)
  
  # Calculate RLI 
  (RLI<-((M-Total)/M))
  
  return(RLI)
}

```

# Retriving and manipulating data from the IUCN data portal (need API key)

```{r IUCN status and category, echo=TRUE}

# Get full list of species currently from IUCN from 09/09/2021
mammals_IUCN_full <- as.data.frame(rl_comp_groups(group = 'mammals', key = apikey)$result)

# Remove subspecies - split structure and remove characters with more than three words
mammals_IUCN_full <- test[sapply(strsplit(as.character(mammals_IUCN_full$scientific_name)," "),length) < 3,]

# Identify missing species from IUCN and EDGE dataset
missing <- mammals_IUCN_full[(setdiff(mammals_IUCN_full$taxonid, EDGE_mammals$RL.ID)),]

# Remove NA column and rows - 17 non matching taxon ID - ask Rikki about these
missing <- missing[!is.na(as.numeric(missing$taxonid)), ]

taxonID <- mammals_IUCN_full$taxonid

# Download red list categories for all species
redlist_status <- do.call(rbind,lapply(taxonID,FUN=function(sp){rl_search(id = sp, key= apikey)$result}))

# Selecting important columns for population status
redlist_status <- redlist_status[c(1,2,7,13,15)]

# Remove capitalization on FAMILIES
redlist_status$family <- str_to_title(redlist_status$family)

# Function to retrieve IUCN data - using ID as a proxy for dataframe

retrieve_IUCN_data <- function(speciesList){
  IUCN_status <- data.frame(TaxonID = character(), Family = character(), Species = character(), Status = character(), Trend = character(), stringsAsFactors=FALSE)
  
  for(sp in speciesList){
    UICN_search <- rl_search(id = sp, key = apikey) 
    if (length(UICN_search$result) == 0){
      IUCN_status_sp <- data.frame(TaxonID = sp,
                                   Family = 'NA',
                                   Species = 'NA', 
                                   Status = 'NA', 
                                   Trend = 'NA',
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
      cat(sp,'----- CHECK\n') 
    }
    else {
      IUCN_status_sp <- data.frame(TaxonID = UICN_search$result$taxonid, 
                                   Family = UICN_search$result$family, 
                                   Species = UICN_search$result$scientific_name, 
                                   Status = UICN_search$result$category, 
                                   Trend = UICN_search$result$population_trend,
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
    }
  }
  return(IUCN_status)
}

# Apply function to a set of species
IUCN_pop_data <- EDGE_mammals

# subset removing NA's
IUCN_pop_data <- IUCN_pop_data[complete.cases(IUCN_pop_data$RL.ID),]

# Retrive data for all valid taxonID
IUCN_pop_full <- retrieve_IUCN_data(IUCN_pop_data$RL.ID[1:10])

missing_sp <- IUCN_pop_data[IUCN_pop_data$RL.ID == "12557" | IUCN_pop_data$RL.ID == "6337 "| IUCN_pop_data$RL.ID == "6336 " | IUCN_pop_data$RL.ID == "12392 " | IUCN_pop_data$RL.ID == "13888 " | IUCN_pop_data$RL.ID == "2538" | IUCN_pop_data$RL.ID == "7915",]

# subset all the rows which do contain NA's
IUCN_NAs <- EDGE_mammals[is.na(EDGE_mammals$RL.ID),]

# reapply function but to look at species names

retrieve_IUCN_data <- function(speciesList){
  IUCN_status <- data.frame(TaxonID = character(), Order = character(), Species = character(), Status = character(), Trend = character(), stringsAsFactors=FALSE)
  
  for(sp in speciesList){
    UICN_search <- rl_search(name = sp, key = apikey) 
    if (length(UICN_search$result) == 0){
      IUCN_status_sp <- data.frame(TaxonID = 'NA',
                                   Order = 'NA',
                                   Species = sp, 
                                   Status = 'NA', 
                                   Trend = 'NA',
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
      cat(sp,'----- CHECK\n') 
    }
    else {
      IUCN_status_sp <- data.frame(TaxonID = UICN_search$result$taxonid, 
                                   Order = UICN_search$result$order, 
                                   Species = UICN_search$result$scientific_name, 
                                   Status = UICN_search$result$category, 
                                   Trend = UICN_search$result$population_trend,
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
    }
  }
  return(IUCN_status)
}

missing_names <- retrieve_IUCN_data(IUCN_NAs$Species)

# remove NA values
missing_names <- missing_names[!complete.cases(missing_names$Status),]



test$RL.ID[is.na(test$RL.ID)] <- 0

EDGE_mammals$Species <- gsub('_', ' ', EDGE_mammals$Species)

test1 <- retrieve_IUCN_data(test$RL.ID)

same_sp <- as.data.frame(intersect(EDGE_mammals$Species, API_list$RLI_sp))

diff_sp <- as.data.frame(setdiff(EDGE_mammals$Species, API_list$RLI_sp))

######################## Calculating change in IUCN RL status - DOWNLOADED DATA
# loading in IUCN dataset

# find out how many species are different by Red List ID - 8 species
length(setdiff(IUCN_pop_trend$internalTaxonId, EDGE_mammals$RL.ID))

# Assign NA values to unknown RL populations
IUCN_pop_trend$populationTrend[IUCN_pop_trend$populationTrend == "Increasing"] <- 2
IUCN_pop_trend$populationTrend[IUCN_pop_trend$populationTrend == "Stable"] <- 1
IUCN_pop_trend$populationTrend[IUCN_pop_trend$populationTrend == "Decreasing"] <- 0
IUCN_pop_trend$populationTrend[IUCN_pop_trend$populationTrend == "Unknown"] <- "NA"

IUCN_pop_trend <- EDGE_mammals %>% 
  dplyr::select(RL.ID, Family, Species) %>% 
  left_join(IUCN_pop_trend, by = c("RL.ID" = "internalTaxonId"))

test <- IUCN_pop_trend %>% 
  dplyr::select(Family, populationTrend) %>% 
  dplyr::group_by(Family) %>% 
  dplyr::summarise(Trend_dec = sum(populationTrend == 0, na.rm = TRUE),
                   Prop_dec = Trend_dec/length(populationTrend[!is.na(populationTrend)]),
                   Trend_inc = sum(populationTrend == 2, na.rm = TRUE),
                   Prop_inc = Trend_inc/length(populationTrend[!is.na(populationTrend)]),
                   Trend_stab = sum(populationTrend == 1, na.rm = TRUE),
                   Prop_stab = Trend_stab/length(populationTrend[!is.na(populationTrend)]))


######################## change in IUCN RL status since 2008 - DOWNLOADED DATA

# Edit old mammmal RL dataframe
mammals_old_RLI <- mammals_old_RLI %>% 
  dplyr::select(Sp_code, Order, Family, Name, X1996.RL.cat, X2008.RL.cat)

# join 2008 and current RL statis up
IUCN_RL_cat_2008 <- IUCN_pop_trend %>% 
  left_join(mammals_old_RLI, by = c("internalTaxonId" = "Sp_code"))

# Removing NA's values from both datasets- only using species which were both in 2008 and present day
IUCN_RL_status_combined <- IUCN_RL_cat_2008[!is.na(IUCN_RL_cat_2008$X2008.RL.cat), ]

# Remove capitalization on FAMILIES
IUCN_RL_status_combined$Family <- str_to_title(IUCN_RL_status_combined$Family)

# Drop DD species
IUCN_RL_status_combined <- subset(IUCN_RL_status_combined, X2008.RL.cat!="DD" & redlistCategory!="DD")


# Convert RL categories into binary (positive integers for current RL cat and negative integers for 2008 RL)
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "LC"] <- 1
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "NT"] <- 2
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "VU"] <- 3
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "EN"] <- 4
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "CR"] <- 5
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "CR(PE)"] <- 6
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "EW"] <- 6
IUCN_RL_status_combined$X2008.RL.cat[IUCN_RL_status_combined$X2008.RL.cat == "EX"] <- 6 

# convert from character to numeric
IUCN_RL_status_combined$X2008.RL.cat <- as.numeric(IUCN_RL_status_combined$X2008.RL.cat)

# Do this for the current redlist categories
IUCN_RL_status_combined$redlistCategory[IUCN_RL_status_combined$redlistCategory == "LC"] <- 1
IUCN_RL_status_combined$redlistCategory[IUCN_RL_status_combined$redlistCategory == "NT"] <- 2
IUCN_RL_status_combined$redlistCategory[IUCN_RL_status_combined$redlistCategory == "VU"] <- 3
IUCN_RL_status_combined$redlistCategory[IUCN_RL_status_combined$redlistCategory == "EN"] <- 4
IUCN_RL_status_combined$redlistCategory[IUCN_RL_status_combined$redlistCategory == "CR"] <- 5
IUCN_RL_status_combined$redlistCategory[IUCN_RL_status_combined$redlistCategory == "EW"] <- 6

# convert from character to numeric
IUCN_RL_status_combined$redlistCategory <- as.numeric(IUCN_RL_status_combined$redlistCategory)

# subtract columns to find change in RL
IUCN_RL_status_combined$RL_change <- (IUCN_RL_status_combined$X2008.RL.cat - IUCN_RL_status_combined$redlistCategory)

#subset important columns in dataframe
IUCN_RL_status_combined <- subset(IUCN_RL_status_combined, select=c(internalTaxonId,scientificName, redlistCategory, Family, X2008.RL.cat, RL_change))


# getting the proportion of species, uplisted, downlisted, no change

RL_change_df <- IUCN_RL_status_combined %>% 
  dplyr::select(Family, RL_change, scientificName) %>% 
  dplyr::group_by(Family) %>%
  dplyr::summarise(richness = length(scientificName), 
                   no_downlisted = sum(RL_change > 0),
                   prop_downlisted = no_downlisted/richness,
                   no_uplisted = sum(RL_change < 0),
                   prop_uplisted = no_uplisted/richness,
                   no_stable = sum(RL_change == 0),
                   prop_stable = no_stable/richness)

IUCN_RL_status_combined <- IUCN_RL_status_combined[order(IUCN_RL_status_combined$Family, decreasing = FALSE),]

# code which counts characters instead of having to convert them xx
sum(lengths(regmatches(IUCN_RL_cat_2008$X2008.RL.cat, gregexpr("EX", IUCN_RL_cat_2008$X2008.RL.cat))))

#######

# retrieve species names for mammals in RLI using API key
API_mammals <- rl_comp_groups(group = 'mammals', key = apikey, parse = TRUE)


API_list <- as.data.frame(API_mammals$result$scientific_name)

colnames(API_list) <- c("RLI_sp")

# Drop row 311 as it's problamatic and is not essential for analysis
API_list <- API_list[-c(310), ]

# Retrieve IUCN population data for all mammals (fingers crossed it works)
IUCN_population_data <- retrieve_IUCN_data(API_list)

test <- as.data.frame(rl_comp_groups(group = 'mammals', key = apikey)$result)

#trying to remove subspecies rows
test <- test[sapply(strsplit(as.character(test$scientific_name)," "),length) < 3,]

# Identify missing species
missing <- test[(setdiff(test$taxonid, EDGE_mammals$RL.ID)),]

missing <- missing[!is.na(as.numeric(missing$taxonid)), ]


```

```{r proportion of threats, echo=TRUE}

t <- rl_threats(name = EDGE_mammals$Species[1:5], key = apikey)

spp <- test$taxonid

# Function to retrieve IUCN threat data - using ID as a proxy for dataframe
# Download red list threats for all species
redlist_threats <- do.call(rbind,lapply(seq_len(length(spp)),FUN=function(i){xi <- rl_threats(id = spp[i], key= apikey); if(length(xi$result)) {data.frame(species=spp[i],xi$result) }})) 

```


```{r manipulating dataset, echo=FALSE}

# load in Red List data from API key
API_mammals <- rl_comp_groups(group = 'mammals', key = apikey, parse = TRUE)

API_list <- as.data.frame(API_mammals$result$scientific_name)

colnames(API_list) <- c("RLI_sp")

API_list <- c(API_list$RLI_sp[1:20])

test <- rl_growth_forms(name = API_list, key = apikey)

RLI_threats <- rl_threats(name = 'Cerdocyon thous', key = apikey)

# Convert the first letter of every word of a string to Uppercase and the rest of the letters are converted to lower case
mammals_old_RLI$Family <- str_to_title(mammals_old_RLI$Family)

# Input "_" between species names
mammals_old_RLI$Name <- gsub(' ', '_', mammals_old_RLI$Name)

# Change population decrease or increase into binary values
mammals_old_RLI$Up.down[mammals_old_RLI$Up.down == "up"] <- 1 
mammals_old_RLI$Up.down[mammals_old_RLI$Up.down == "down"] <- 0 

# Get RLI for mammal families

RLI_summary <- mammals_old_RLI %>% 
  dplyr::select(Family, X1996.RL.cat, X2008.RL.cat, Up.down) %>% # important when specifiying varibales to just use variable names in the rest of the pipeline
  #filter(mammals_old_RLI) %>% 
  group_by(Family) %>% 
  dplyr::summarise(RLI_1996 = get_rli(X1996.RL.cat),
            RLI_2008 = get_rli(X2008.RL.cat),
            pop_trend_inc = sum(Up.down == "1", na.rm = TRUE),
            pop_trend_dec = sum(Up.down == "0", na.rm = TRUE)) 



# Red list random sample
RLI_sample <- mammals_old_RLI[sample(nrow(mammals_old_RLI), 200), ]
  
get_rli(RLI_sample$X1996.RL.cat)


```

# Calulating LPI lambdas for mammal families

```{r LPI data, echo=TRUE}

require(rlpi)

# Creating an infile
# First read the population table (this is the Living Planet Database excluding confidential records)
lpi_data <- read.csv("example_data/LPI_LPR2016data_public.csv", na.strings = "NULL")

# Create an infile from all the data. All the population data in the 'lpi_data' table will be converted and stored in a file called 'example_data_pops.txt' and a file called 'example_data_infile.txt' will be created that references the first file (the infile name will also be stored in the returned variable 'example_infile_name')

# Here we select the first 100 populations by creating an index vector that's FALSE for all rows, then setting the first 100 rows to TRUE
index_vector = rep(FALSE, nrow(lpi_data))
index_vector[1:100] = TRUE

example_infile_name <- create_infile(lpi_data, index_vector=index_vector, name="example_data")

# An index can be created using this infile, for the period 1970 to 2014 with 100 bootstraps.
example_lpi <- LPIMain(example_infile_name, REF_YEAR = 1970, PLOT_MAX = 2014, BOOT_STRAP_SIZE = 100, VERBOSE=FALSE)

# Remove NAs (trailing years with no data)
example_lpi <- example_lpi[complete.cases(example_lpi), ]

# Plot the resulting index
ggplot_lpi(example_lpi, title = "example_lpi", xlims=c(1970, 2012), ylim=c(0, 2))

######################################################################
# Create infile for LPI report for mammals
# Load in LPI dataset from 2020 LPI report
LPI_mammals <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Monitoring_population_trends/LPI_mammals.csv", na.strings = NULL)

index_vector = rep(TRUE, nrow(LPI_mammals))

mammal_infile <- create_infile(LPI_mammals, index_vector=index_vector, name="mammal_data")

# An index can be created using this infile, for the period 1970 to 2014 with 100 bootstraps.
mammal_lpi <- LPIMain(mammal_infile, REF_YEAR = 1970, PLOT_MAX = 2014, BOOT_STRAP_SIZE = 100, VERBOSE=FALSE)

ggplot_lpi(mammal_lpi, ylims=c(0, 2))

########################################################################
#EXAMPLES FOR CALCULATING LAMBDAS
# Get example data from package
# Copy zipped data to local directory 
file.copy(from=system.file("extdata", "example_data.zip", package = "rlpi"), to=getwd())

# Extract data, this will create a directory of terrestrial LPI data to construct a terrestrial index from.
unzip("example_data.zip")

# Make a Nearctic LPI 

# Default gives 100 bootstraps (this takes a couple of minutes to run on a 2014 MacBook)
Nearc_lpi <- LPIMain("example_data/terrestrial_class_nearctic_infile.txt", use_weightings = 1, VERBOSE=FALSE)

# Remove NAs (trailing years with no data)
Nearc_lpi <- Nearc_lpi[complete.cases(Nearc_lpi), ]
# This produces a simple plot, but we can use ggplot_lpi to produce a nicer version
ggplot_lpi(Nearc_lpi, ylims=c(0, 2))

# Make a Nearctic Mammals LPI 
# Default gives 100 bootstraps (this will take a few minutes to run on a 2014 MacBook)
Nearc_mams_lpi <- LPIMain("example_data/T_Nearctic_mammalia_infile.txt", VERBOSE=FALSE)

# Remove NAs (trailing years with no data)
Nearc_mams_lpi <- Nearc_mams_lpi[complete.cases(Nearc_mams_lpi), ]
# Nicer plot
ggplot_lpi(Nearc_mams_lpi, ylims=c(0, 2))

# Make a Nearctic Birds LPI 
# Default gives 100 bootstraps (this will take a few minutes to run on a 2014 MacBook)
Nearc_birds_lpi <- LPIMain("example_data/terrestrial_Nearctic_Aves_infile.txt", VERBOSE=FALSE)

### seeing how much data coverage there is for edge priority lineages
LPI_coverage <- LPI_mammals[!LPI_mammals$Family %in% EDGE_priority_lineages$Family,]

proption_LPI <- sum(length(LPI_coverage))/sum(length(LPI_mammals$Species))

# count number of species in LPI by family
LPI_summary <- LPI_mammals %>% 
  group_by(Family) %>% 
  dplyr::summarise(n = length(unique((Binomial))))

# Find % of species of LPI in each Family

LPI_richness <- left_join(EDGE_mammal_summary, LPI_summary, by = "Family")

LPI_richness <- LPI_richness %>% 
  group_by(Family) %>% 
  mutate(lpi_richness = (n/richness)*100)

# no of species over 50% richness: 26 families which have above 50% species coverage and an extra 10 which have above 33% coverage
sum(LPI_richness$lpi_richness > 33, na.rm = TRUE)

# How many of those are EDGE lineages - there are 23 priority (19 which have more than 50%, and an extra 5 which have more than 33%) EDGE populations which have a coverage of both 33 and 50%
LPI_coverage <- LPI_richness[!LPI_richness$Family %in% EDGE_priority_lineages$Family,]

sum(LPI_coverage$lpi_richness > 33, na.rm = TRUE)

```

# Load in mammal trait data 

```{r load PanTHERIA dataset, echo=TRUE}

#load in dataset - 5798 species
mannal_bodysize_full <- pantheria

# Get mean body size for each family

mammal_bodysize_full <- mannal_bodysize_full %>% 
  select(Family, Genus, Species, AdultBodyMass_g, SexualMaturityAge_d) %>% 
  group_by(Family) %>% 
  summarise(bodysize_mean = mean(AdultBodyMass_g, na.rm = TRUE),
            Genlength_mean = mean(SexualMaturityAge_d, na.rm = TRUE))

# join to big dataframe

# load in Pacifici et al. (2013) generation length dataset

Generation_length <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Monitoring_population_trends/Genlength_mammals.csv")

# Get mean genreation length (days) for each family
mammal_genlength <- Generation_length %>% 
  dplyr::select(TaxID, Family, Scientific_name, GenerationLength_d) %>% 
  group_by(Family) %>% 
  summarise(Gen_length = mean(GenerationLength_d, na.rm = TRUE))

# JOin to main dataset?


```

```{r combine data sources, echo=TRUE}


```
