---
title: "PHASE_TWO_MONITORING_POPULATION_STATUS"
author: "Chris Low"
date: "18/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

# PHASE TWO: MONITORING THE POPULATION STATUS OF EVOLUTIONARY DISTINCT LIENAGES

```{r load packages, echo=FALSE}

library(dplyr)
library(plyr)
library(rredlist)
library(stringr)
library(tidyverse)
library(remotes)
library(devtools)
install.packages('RS-eco/traitdata')

```


Load in data to monitor population for Mammal lineages

```{r load data, echo=FALSE}

mammals_old_RLI <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Monitoring_population_trends/Mammal_RLI.csv")

```

# Function to calculate the Red List Index (RLI)

```{r Red List function, echo=FALSE}

## RLI script

# Label Red List categories
wtEX<-5
wtPE<-5
wtEW<-5
wtPEW<-5
wtCR<-4
wtEN<-3
wtVU<-2
wtNT<-1
wtLC<-0

# Function to calculate the RLI from a set of species categories

get_rli <- function(species_categories) {
  # Get the number of species in each category, including the old categories
  nEX<-sum(species_categories=="EX" | species_categories=="E", na.rm = T)
  nPE<-sum(species_categories=="PE", na.rm = T)
  nEW<-sum(species_categories=="EW", na.rm = T)
  nPEW<-sum(species_categories=="PEW", na.rm = T)
  nCR<-sum(species_categories=="CR", na.rm = T)
  nEN<-sum(species_categories=="EN", na.rm = T)
  nVU<-sum(species_categories=="VU" | species_categories=="T", na.rm = T)
  nNT<-sum(species_categories=="NT"  | species_categories=="LR/nt", na.rm = T)
  nLC<-sum(species_categories=="LC" | species_categories=="LR/lc" | species_categories=="LR/cd", na.rm = T)
  
  # Multiply these by the respective weights and sum
  Total<-(wtEX*nEX)+(wtPE*nPE)+(wtEW*nEW)+(wtPEW*nPEW)+(wtCR*nCR)+(wtEN*nEN)+(wtVU*nVU)+(wtNT*nNT)+(wtLC*nLC)
  
  # Work out the âworse case scenarioâ
  M<-((nEX+nPE+nEW+nPEW+nCR+nEN+nVU+nNT+nLC)*wtEX)
  
  # Calculate RLI 
  (RLI<-((M-Total)/M))
  
  return(RLI)
}

```

# Retriving and manipulating data from the IUCN data portal (need API key)

```{r IUCN status and category, echo=TRUE}

# Function to retrieve IUCN data

retrieve_IUCN_data <- function(speciesList){
  IUCN_status <- data.frame(TaxonID = character(), Order = character(), Species = character(), Status = character(), Trend = character(), stringsAsFactors=FALSE)
  
  for(sp in speciesList){
    UICN_search <- rl_search(id = sp, key = apikey) 
    if (length(UICN_search$result) == 0){
      IUCN_status_sp <- data.frame(TaxonID = sp,
                                   Order = 'NA',
                                   Species = 'NA', 
                                   Status = 'NA', 
                                   Trend = 'NA',
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
      cat(sp,'----- CHECK\n') 
    }
    else {
      IUCN_status_sp <- data.frame(TaxonID = UICN_search$result$taxonid, 
                                   Order = UICN_search$result$order, 
                                   Species = UICN_search$result$scientific_name, 
                                   Status = UICN_search$result$category, 
                                   Trend = UICN_search$result$population_trend,
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
    }
  }
  return(IUCN_status)
}

# Apply function to a set of species
IUCN_pop_data <- EDGE_mammals

# subset removing NA's
IUCN_pop_data <- IUCN_pop_data[complete.cases(IUCN_pop_data$RL.ID),]

# Retrive data for all valid taxonID
IUCN_pop_full <- retrieve_IUCN_data(IUCN_pop_data$RL.ID)

missing_sp <- IUCN_pop_data[IUCN_pop_data$RL.ID == "12557" | IUCN_pop_data$RL.ID == "6337 "| IUCN_pop_data$RL.ID == "6336 " | IUCN_pop_data$RL.ID == "12392 " | IUCN_pop_data$RL.ID == "13888 " | IUCN_pop_data$RL.ID == "2538" | IUCN_pop_data$RL.ID == "7915",]

# subset all the rows which do contain NA's
IUCN_NAs <- EDGE_mammals[is.na(EDGE_mammals$RL.ID),]

# reapply function but to look at species names

retrieve_IUCN_data <- function(speciesList){
  IUCN_status <- data.frame(TaxonID = character(), Order = character(), Species = character(), Status = character(), Trend = character(), stringsAsFactors=FALSE)
  
  for(sp in speciesList){
    UICN_search <- rl_search(name = sp, key = apikey) 
    if (length(UICN_search$result) == 0){
      IUCN_status_sp <- data.frame(TaxonID = 'NA',
                                   Order = 'NA',
                                   Species = sp, 
                                   Status = 'NA', 
                                   Trend = 'NA',
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
      cat(sp,'----- CHECK\n') 
    }
    else {
      IUCN_status_sp <- data.frame(TaxonID = UICN_search$result$taxonid, 
                                   Order = UICN_search$result$order, 
                                   Species = UICN_search$result$scientific_name, 
                                   Status = UICN_search$result$category, 
                                   Trend = UICN_search$result$population_trend,
                                   stringsAsFactors=FALSE)
      IUCN_status <- rbind(IUCN_status, IUCN_status_sp)
    }
  }
  return(IUCN_status)
}

missing_names <- retrieve_IUCN_data(IUCN_NAs$Species)

# remove NA values
missing_names <- missing_names[!complete.cases(missing_names$Status),]



test$RL.ID[is.na(test$RL.ID)] <- 0

EDGE_mammals$Species <- gsub('_', ' ', EDGE_mammals$Species)

test1 <- retrieve_IUCN_data(test$RL.ID)

same_sp <- as.data.frame(intersect(EDGE_mammals$Species, API_list$RLI_sp))

diff_sp <- as.data.frame(setdiff(EDGE_mammals$Species, API_list$RLI_sp))

######################## loading in IUCN dataset

IUCN_pop_trend <- read.csv("C:/Users/Student/Zoological Society of London/EDGEofExistence - Chris Low - EDGE lineages/Project II/Data and analysis/Monitoring_population_trends/pop_trend_IUCN.csv")

# find out how many species are same
count(intersect(IUCN_pop_trend$internalTaxonId, EDGE_mammals$RL.ID))

length(setdiff(EDGE_mammals$Species, IUCN_pop_trend$scientificName))

length(setdiff(EDGE_mammals$Species, IUCN_pop_full$Species))


#######

# retrieve species names for mammals in RLI using API key
API_mammals <- rl_comp_groups(group = 'mammals', key = apikey, parse = TRUE)


API_list <- as.data.frame(API_mammals$result$scientific_name)

colnames(API_list) <- c("RLI_sp")

# Drop row 311 as it's problamatic and is not essential for analysis
API_list <- API_list[-c(310), ]

# Retrieve IUCN population data for all mammals (fingers crossed it works)
IUCN_population_data <- retrieve_IUCN_data(API_list)


test <- rl_growth_forms(name = API_list, key = apikey)

RLI_threats <- rl_threats(name = 'Cerdocyon thous', key = apikey)

```


```{r manipulating dataset, echo=FALSE}

# load in Red List data from API key
API_mammals <- rl_comp_groups(group = 'mammals', key = apikey, parse = TRUE)

API_list <- as.data.frame(API_mammals$result$scientific_name)

colnames(API_list) <- c("RLI_sp")

API_list <- c(API_list$RLI_sp[1:20])

test <- rl_growth_forms(name = API_list, key = apikey)

RLI_threats <- rl_threats(name = 'Cerdocyon thous', key = apikey)

# Convert the first letter of every word of a string to Uppercase and the rest of the letters are converted to lower case
mammals_old_RLI$Family <- str_to_title(mammals_old_RLI$Family)

# Input "_" between species names
mammals_old_RLI$Name <- gsub(' ', '_', mammals_old_RLI$Name)

# Change population decrease or increase into binary values
mammals_old_RLI$Up.down[mammals_old_RLI$Up.down == "up"] <- 1 
mammals_old_RLI$Up.down[mammals_old_RLI$Up.down == "down"] <- 0 

# Get RLI for mammal families

RLI_summary <- mammals_old_RLI %>% 
  dplyr::select(Family, X1996.RL.cat, X2008.RL.cat, Up.down) %>% # important when specifiying varibales to just use variable names in the rest of the pipeline
  #filter(mammals_old_RLI) %>% 
  group_by(Family) %>% 
  dplyr::summarise(RLI_1996 = get_rli(X1996.RL.cat),
            RLI_2008 = get_rli(X2008.RL.cat),
            pop_trend_inc = sum(Up.down == "1", na.rm = TRUE),
            pop_trend_dec = sum(Up.down == "0", na.rm = TRUE)) 



# Red list random sample
RLI_sample <- mammals_old_RLI[sample(nrow(mammals_old_RLI), 200), ]
  
get_rli(RLI_sample$X1996.RL.cat)


```

# Load in mammal trait data 

```{r load PanTHERIA dataset, echo=TRUE}


# Install traitdata package from Github
devtools::install_github('EcologicalTraitData/traitdataform')

```
